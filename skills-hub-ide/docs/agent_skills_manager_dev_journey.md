# Agent Skills Manager 开发历程与技术复盘

> **创建日期**: 2026-02-05
> **项目目标**: 构建一个跨平台、健壮且交互友好的 AI 技能管理工具，实现从 Source -> Hub -> IDE 的两阶段分发。

---

## 1. 缘起：从 Bash 到 Python 的进化

最初，我们使用 `skills_manager.sh` (Bash 脚本) 来管理技能分发。虽然 Bash 在 Linux/macOS 上很方便，但随着需求复杂度的增加，我们遇到了以下瓶颈：

- **跨平台兼容性差**: Windows 环境下运行 Bash 脚本困难，路径分隔符处理繁琐。
- **逻辑维护困难**: 随着功能增加（如交互式菜单、错误处理、批量扫描），Shell 脚本的可读性和可维护性急剧下降。
- **高级功能受限**: 难以实现复杂的按键事件监听和精细的 UI 控制。

**决策**: 迁移至 Python。
利用 Python 的 `pathlib` 处理跨平台路径，`argparse` 处理参数，以及模块化设计来提升代码质量。

## 2. 架构设计：模块化与两阶段分发

为了保证工具的长期可维护性，我们采用了模块化设计：

```text
agent-skills-manager/
├── scripts/
│   ├── main.py          # 入口程序：负责流程编排
│   └── core/            # 核心逻辑库
│       ├── detector.py  # IDE 环境探测 (Trae, Antigravity)
│       ├── linker.py    # 软链接核心逻辑 (处理 Errno 1, Win/Unix 差异)
│       ├── menu.py      # 交互式 UI 组件 (本次调试的核心战场)
│       └── utils.py     # 日志与颜色常量
```

**核心流程 (Two-Stage Distribution)**:

1.  **Stage 1 (Source -> Hub)**: 将原始技能链接到 `~/.agents/skills` (中转站)。
2.  **Stage 2 (Hub -> IDE)**: 将中转站的技能链接到具体的 IDE 目录 (如 `~/.trae/skills`)。

## 3. 核心挑战：交互式菜单与“方向键之战”

这是本项目中最具技术挑战，也是我们反复调试最多次的部分。

### 3.1 问题现象

在实现 `interactive_select` (多选菜单) 时，我们需要监听用户的按键（上下移动光标，空格选择）。
**Bug**: 在某些终端环境下，用户按下方向键（如 `↑` 或 `↓`）时，程序会**误判为 ESC 键**，导致直接退出菜单，或者没有任何反应。

### 3.2 技术背景：ANSI 转义序列

终端的方向键本质上发送的是一串字符序列（Escape Sequence），通常以 `ESC` (Hex: `0x1b`) 开头。

- **上箭头**: `ESC` + `[` + `A`
- **下箭头**: `ESC` + `[` + `B`

程序需要区分：用户是按了 **单独的 ESC 键**（退出），还是按了 **方向键序列的开头**。

### 3.3 调试与演进过程

#### 第一阶段：简单的 `sys.stdin.read` (失败)

最初，我们使用 Python 标准库的 `sys.stdin.read(1)` 读取按键。

- **问题**: `sys.stdin` 是带缓冲的。当我们尝试用 `select` 非阻塞地探测后续字符时，后续的 `[` 和 `A` 可能已经被 Python 的缓冲区“吞”进去了，导致 `select` 认为没有数据。
- **结果**: 程序读到第一个 `ESC`，发现后面“没数据”，于是判定用户按了退出键。

#### 第二阶段：调整超时时间 (部分缓解)

我们尝试将 `select` 的超时时间从 `0.001s` 增加到 `0.05s`。

- **思路**: 给终端更多时间发送后续字符。
- **结果**: 有所改善，但在网络延迟或某些终端模拟器下依然不稳定。

#### 第三阶段：诊断模式 (定位根因)

为了彻底搞清楚发生了什么，我们编写了一个 `debug_key.py`，直接打印终端发送的 Hex 码。
**用户反馈数据**:

```
收到: '\x1b' (Hex: 0x1b)
收到: '[' (Hex: 0x5b)
收到: 'B' (Hex: 0x42)
```

这证实了终端发送的是标准的 ANSI 序列，问题出在**读取时机**和**缓冲机制**上。

#### 第四阶段：稳健模式 (最终解决方案)

我们实施了两个关键改动，彻底解决了问题：

1.  **绕过 Python 缓冲区 (`os.read`)**:
    不再使用 `sys.stdin.read()`，而是直接操作文件描述符 `fd = sys.stdin.fileno()`，使用 `os.read(fd, 1)`。这确保了我们能直接从操作系统内核缓冲区拿到每一个字节，没有任何中间商赚差价。

2.  **增加超时缓冲与完整序列读取**:
    - 将 `select` 超时增加到 **0.1s (100ms)**。这对人类是瞬间，对计算机是永恒，足以等待序列传输完成。
    - 逻辑优化：一旦读到 `ESC`，且后续读到了 `[` 或 `O`，就**强制等待并读取第三个字节**，绝不提前返回。

**最终代码逻辑**:

```python
# 核心逻辑伪代码
ch1 = os.read(fd, 1)
if ch1 == b'\x1b':
    # 既然是 ESC，给 0.1s 看看后面有没有跟屁虫
    if select(fd, 0.1s):
        ch2 = os.read(fd, 1)
        if ch2 in [b'[', b'O']:
             # 既然有前缀，那必然还有第三个字节，再读！
             ch3 = os.read(fd, 1)
             # 拼接序列，判定方向
```

## 4. 体验优化：UI 与错误引导

除了底层交互，我们在用户体验上也做了精细打磨：

- **沙箱权限处理 (Errno 1)**: 在 IDE 内置终端（受限环境）运行失败时，自动检测并生成**高亮的一键修复命令**，引导用户去外部终端执行。
- **可视化反馈**:
  - 成功/失败计数分离（绿/红）。
  - 失败列表垂直排版，清晰易读。
  - 关键信息加粗高亮。

## 5. 总结

通过这次重构，`Agent Skills Manager` 已经从一个简单的脚本进化为一个**生产级**的工具：

1.  **健壮**: 能够处理各种复杂的终端输入情况。
2.  **友好**: 提供清晰的交互指引和错误解决方案。
3.  **通用**: 核心逻辑与 UI 分离，未来可轻松扩展更多功能。

---

_Created by Trae AI Assistant_
